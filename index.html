<!DOCTYPE- html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="soccerW.png">
<link rel="icon" href="soccerW.png" type="image/png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes"> 
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ì „ë¬¸ê°€ìš© ì¶•êµ¬ ì‘ì „íŒ PRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
 --red-color: #e74c3c;
 --blue-color: #3498db;
 --bg-color: #f4f7f6;
 --toggle-btn-color: #ffffff; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; 

      background-color: var(--bg-color); 
      background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), 
                    url('ful.png'); 
/* ------------- ë°±ê·¸ë¼ìš´ë“œ ì´ë¯¸ì§€ ------------------ */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-family: 'Pretendard', sans-serif; 
      overflow-x: hidden; width: 100%; touch-action: pan-y;
    }
    
/* ë©”ë‰´ ë²„íŠ¼ ì¡°ì ˆ*/
    #toggleMenuBtn { 
  padding: 8px 15px;
  width: 130px; height: 45px;
  background: var(--toggle-btn-color);
  border-radius: 10px; font-weight:
  bold; border: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

#redAlignBtn { color: var(--red-color); }
#blueAlignBtn { color: var(--blue-color); }

    #field { 
width: 100%; 
max-width: calc(95vh * 1.414); /* ì„¸ë¡œ ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ê°€ë¡œê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ ë°©ì§€ */
aspect-ratio: 1.414 / 1; 
max-height: 85vh;
/* ------------- ì¶•êµ¬ì¥ í•„ë“œ ì´ë¯¸ì§€ ------------------ */
background-color: #27ae60; 
background-size: 100% 100%; 
border: 4px solid #fff; 
position: relative; z-index: 1; 
overflow: hidden; 
}
    
    #field-container { 
position: relative; 
width: 100%; 
display: flex;
justify-content: center;
align-items: center;
padding: 5px; /* í™”ë©´ ëì— ë„ˆë¬´ ë¶™ì§€ ì•Šê²Œ ì‚´ì§ ì—¬ìœ  */
touch-action: none; 
 }

#drawingCanvas {
    position: absolute; /* í•„ë“œ ìœ„ì— ë¶• ë„ì›€ */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 150;       /* ì„ ìˆ˜ë“¤ë³´ë‹¤ ë†’ì€ ì¸µ */
    pointer-events: none; 

}

.pen-active #drawingCanvas {
    pointer-events: auto;
}

/* ë°°ê²½ ì´ë¯¸ì§€ ë ˆì´ì–´ */
#field-bg {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background-size: 100% 100%;
  z-index: 1; /* ê°€ì¥ ì•„ë˜ */
}

/* ë¼ì¸ ì´ë¯¸ì§€ ë ˆì´ì–´ (íˆ¬ëª… PNG ê¶Œì¥) */
#field-lines {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background-image: url("filed.png");
  background-size: 100% 100%;
  pointer-events: none; /* ë¼ì¸ì´ ë§ˆìš°ìŠ¤ í´ë¦­ì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì„¤ì • */
  z-index: 2; /* ë°°ê²½ë³´ë‹¤ ìœ„ */
}


    #menuOverlay { position: absolute; top: 0; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 1000; pointer-events: none; }
    
    /* ê°€ë¡œ 1ì—´ ìœ ì§€ ë° ìë™ í­ ì¡°ì ˆ */
    #bottomControls { 
      pointer-events: auto; width: 95%; max-width: calc(95vh * 1.414);
      background: rgba(255, 255, 255, 0.98); 
      border-radius: 15px; padding: 10px; 
      display: flex; flex-direction: row; /* ê°€ë¡œ ì •ë ¬ */
      justify-content: center; gap: 4px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.4); 
      backdrop-filter: blur(10px); transition: opacity 0.3s ease;
      z-index: 1001; margin-top: 10px; touch-action: auto;
      overflow-x: auto; /* ë„ˆë¬´ ì¢ìœ¼ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
    }
    #bottomControls.collapsed { display: none; }


    /* í…ìŠ¤íŠ¸ ì„ ëª…ë„ (ê·¸ë¦¼ì ì œê±°) */
    .draggable { 
      border-radius: 50%; display: flex; align-items: center; justify-content: center; 
      position: absolute; cursor: grab; font-weight: bold; z-index: 10 !important; 
      background-size: cover; background-position: center; 
      text-shadow: none !important; /* ê·¸ë¦¼ì ì ˆëŒ€ ê¸ˆì§€ */
      pointer-events: auto; transform: translate(-50%, -50%); 
      touch-action: none; transition: left 0.4s ease-out, top 0.4s ease-out;
    }

    .player { border: 4px solid #000; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
    .player[data-team="red"] { border-color: var(--red-color); }
    .player[data-team="blue"] { border-color: var(--blue-color); }
    
    .ball { 
width: 45px; 
height: 45px; 
background-image: url("Wball.png"); 
background-size: cover;
z-index: 1000 !important; 
border: 2px solid #333; 
}
/* ------------- ì¶•êµ¬ê³µ ì´ë¯¸ì§€ ------------------ */

    .card { 
background: white; 
padding: 5px 4px; 
border-radius: 8px; 
border: 1px solid #ddd; 
flex: 1; 
min-width: 120px; /* ì¹´ë“œì˜ ìµœì†Œ ë„ˆë¹„ í™•ë³´ */
display: flex; 
flex-direction: column; 
overflow: hidden; 
    }

    .card-header { 
display: flex; 
justify-content: center; 
align-items: center; 
margin-bottom: 8px; 
border-bottom: 2px solid #eee; 
padding-bottom: 5px; 
}
    .card-header h3, .card h3 {
  font-size: 15px !important; 
  margin: 2px 0 !important;
}

    .formation-select { 
  font-size: 10px;
  padding: 2px;
  max-width: 65px;
}

    .input-row { display: flex; width: 100%; gap: 3px; margin-bottom: 8px; align-items: center; }
    input[type="text"] { flex: 1; min-width: 0; height: 30px; padding: 0 5px; border: 1.5px solid #ccc; border-radius: 6px; font-size: 12px; outline: none; }
    
input[type="text"], .btn-add, .color-toggle, .file-btn-box {
  height: 24px !important; 
  font-size: 10px !important;
}

    .color-toggle { display: flex; border: 1px solid #ccc; border-radius: 6px; overflow: hidden; height: 30px; flex-shrink: 0; }
    .color-toggle input { display: none; }
    .color-toggle label { width: 25px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; background: #eee; color: #999; }
    .color-toggle input:checked + label { background: #333; color: #fff; }
    .color-toggle input:checked + label.label-white { background: #fff; color: #000; border: 1px solid #333; }

    .btn-add { height: 30px; padding: 0 8px; font-size: 12px; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: bold; flex-shrink: 0; }
    .file-btn-box { height: 30px; border: 1.5px solid #ccc; border-radius: 6px; margin-bottom: 8px; background: #f8f9fa; cursor: pointer; display: flex; align-items: center; width: 100%; padding: 0 5px; overflow: hidden; }
    .setting-grid { 
display: grid; 
grid-template-columns: 40px 1fr !important;; 
column-gap: 3px; 
align-items: center; 
font-size: 10px; 
width: 100% !important; 
margin-bottom: 3px; 
overflow: hidden; /* ì‚ì ¸ë‚˜ê° ë°©ì§€ */
}
    
    .data-btn-container { display: flex; flex-direction: column; gap: 5px; margin-top: auto; }
.btn-full {
  padding: 4px 2px !important;
  font-size: 10px !important;
  border-radius: 4px;
}

    .list-item { 
display: flex; 
justify-content: space-between; 
padding: 4px 0; 
border-bottom: 1px dashed #eee; 
font-size: 11px; 
align-items: center; 
gap: 3px; 
}
    .btn-small { padding: 3px 5px; font-size: 10px; border: 1px solid #ddd; background: #fff; border-radius: 3px; cursor: pointer; }

@media screen and (max-width: 600px) {
      #bottomControls {
        padding: 5px;
        gap: 2px;
}

/* ê²Œì´ì§€(ìŠ¬ë¼ì´ë”) ìì²´ê°€ ë¶€ëª¨ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šê²Œ ì„¤ì • */
input[type="range"] {
    width: 100% !important; /* ë¶€ëª¨ ë„ˆë¹„ ì•ˆì—ì„œë§Œ ì‘ë™ */
    height: 12px;
    margin: 0 !important;
    cursor: pointer;
  }
      }

/* ìƒë‹¨ íˆ´ë°”: ê³µê°„ ë¶€ì¡± ì‹œ ì¤„ë°”ê¿ˆ í—ˆìš© */
.top-toolbar {
display: flex;
  align-items: center;
  justify-content: center; /* ìì‹ë“¤ì„ ì¤‘ì•™ìœ¼ë¡œ ëª¨ìŒ */
  width: 95%;
  max-width: calc(95vh * 1.414);
  margin: 2px auto;
  gap: 5px; /* ë²„íŠ¼ ì‚¬ì´ì˜ ê°„ê²© */
}

/* ë„êµ¬ ê·¸ë£¹ ë””ìì¸ */
.tool-group { 
  display: flex; 
  gap: 3px; 
  background: rgba(255,255,255,0.9); 
  padding: 4px; 
  border-radius: 8px; 
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* ì •ë ¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.align-btn {
  padding: 5px 8px;
  font-size: 12px;
  cursor: pointer;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
}
.hidden { display: none !important; }

/* ì„¤ì •ì°½ ë‚´ë¶€ ìŠ¬ë¼ì´ë“œ ìŠ¤ìœ„ì¹˜ */
.switch { position: relative; display: inline-block; width: 34px; height: 18px; vertical-align: middle; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 18px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #27ae60; }
input:checked + .slider:before { transform: translateX(16px); }

.center-box { display: flex; justify-content: center; }
.side-box { display: flex; align-items: center; width: 100%; }
.side-box.left { justify-content: flex-end; padding-right: 8px; }
.side-box.right { justify-content: flex-start; padding-left: 8px; }

/* ê¸°ë³¸ ì„ ìˆ˜ ê³µí†µ */
.player {
    transition: all 0.3s ease; /* ëª¨ì–‘ ë°”ë€” ë•Œ ë¶€ë“œëŸ½ê²Œ */
    overflow: hidden;
}

/* ì›í˜• */
.player.shape-circle {
    border-radius: 50% !important;
    clip-path: circle(50% at 50% 50%);
}

/* ì‚¬ê°í˜• */
.player.shape-square {
    border-radius: 4px !important;
    clip-path: inset(0% 0% 0% 0% round 4px);
}

/* ì‚¼ê°í˜• */
.player.shape-triangle {
    clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
    border: none !important; /* ì‚¼ê°í˜•ì¼ ë• í…Œë‘ë¦¬ê°€ ì–´ìƒ‰í•  ìˆ˜ ìˆìŒ */
}

/* ìœ ë‹ˆí¼ ëª¨ì–‘ */
.player.shape-jersey {
    clip-path: polygon(30% 0%, 70% 0%, 100% 20%, 85% 45%, 75% 35%, 75% 100%, 25% 100%, 25% 35%, 15% 45%, 0% 20%);
    border: none !important;
}

/* ì„¸ëª¨ì™€ ìœ ë‹ˆí¼ì— ë²ˆì§ ì—†ëŠ” ì„ ëª…í•œ ì™¸ê³½ì„  ì ìš© */
.player.shape-triangle, 
.player.shape-jersey {
    border: none !important;
    /* ìƒ, í•˜, ì¢Œ, ìš° 4ë°©í–¥ìœ¼ë¡œ 1pxì”© ê·¸ë¦¼ìë¥¼ ê²¹ì³ì„œ ì„ ì²˜ëŸ¼ ë³´ì´ê²Œ í•¨ */
    filter: drop-shadow(1px 0 0 #000) 
            drop-shadow(-1px 0 0 #000) 
            drop-shadow(0 1px 0 #000) 
            drop-shadow(0 -1px 0 #000);
}

/* íŒ€ ìƒ‰ìƒìœ¼ë¡œ ë” ëšœë ·í•˜ê²Œ êµ¬ë¶„í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì½”ë“œ ì¶”ê°€ */
.player[data-team="red"].shape-triangle, 
.player[data-team="red"].shape-jersey {
    filter: drop-shadow(1.5px 0 0 #330000) drop-shadow(-1.5px 0 0 #330000) 
            drop-shadow(0 1.5px 0 #330000) drop-shadow(0 -1.5px 0 #330000);
}

.player-list-item {
    display: flex;
    align-items: center;
    padding: 5px;
    margin-bottom: 2px;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 4px;
    transition: transform 0.2s;
}

/* ë“œë˜ê·¸ í•¸ë“¤ì— ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì¡ê¸° ì†ëª¨ì–‘ */
.drag-handle:hover {
background: #e0e0e0;
  color: #333 !important;
}

/* ë“œë˜ê·¸ ì¤‘ì¸ íƒ€ê²Ÿì— ì‹œê°ì  íš¨ê³¼ */
.list-item.drag-over {
  border-top: 2px solid #007bff;
}

/* ë“œë˜ê·¸ ì¤‘ì¸ í•­ëª©ê³¼ ê²¹ì¹  ë•Œ ì‹œê°ì  íš¨ê³¼ */
.player-list-item[draggable="true"]:active {
    cursor: grabbing;
}

/* íœ íˆ´ë°” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
.pen-toolbar-container {
    position: fixed;
    top: 60px; /* ì˜µì…˜ ë²„íŠ¼ ì•„ë˜ìª½ì— ìœ„ì¹˜ */
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 15px;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
}

.pen-btn {
    border: none;
    padding: 6px 12px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    background: #444;
    color: white;
    font-size: 12px;
    transition: 0.2s;
}

.clear-btn { background: #95a5a6; }
.clear-btn:hover { background: #7f8c8d; }

.pen-width-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 10px;
    gap: 2px;
}

#penColorPicker {
    width: 30px;
    height: 30px;
    border: none;
    background: none;
    cursor: pointer;
}

#penWidth { width: 80px; cursor: pointer; }

  </style>
</head>
<body>

<div class="top-toolbar">
  <div class="side-box left" style="display: flex; gap: 5px;">
<div id="penToolbar" style="display:none; align-items:center; gap:12px; background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 30px; border: 1px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.12); margin-right: 15px;">
    
    <div style="display:flex; align-items:center; position: relative; gap: 10px;">
    <button id="penToggleBtn" onclick="togglePenMode()" 
            style="padding:5px 12px; border-radius:20px; border:none; background:#ffffff; color:white; font-size:16px; font-weight:bold; cursor:pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        ğŸ–ï¸
    </button>

        <input type="color" id="penColorPicker" value="#000000" onchange="changePenColor(this.value)" 
               style="width:35px; height:30px; border:none; cursor:pointer; background:none; padding:0; border-radius: 50%;">
    </div>

    <div style="display:flex; align-items:center; gap:1px;">
        <span style="font-size:14px; font-weight:600; color:#666;">â°</span>
        <input type="range" id="penWidth" min="1" max="15" value="3" oninput="updateLineWidth(this.value)" 
               style="width:50px; cursor:pointer; accent-color: #444;">
    </div>

    <button onclick="clearCanvas()" 
            style="padding:5px 10px; border-radius:20px; border:none; background:#ffffff; color:#333; font-size:16px; font-weight:bold; cursor:pointer; transition: all 0.2s;">
        âŒ
    </button>
</div>
    <button id="redAlignBtn" class="align-btn red-btns hidden" style="background: #000; color: #e74c3c; font-weight: bold;" onclick="alignPlayers('red', false)">â—€ ì •ë ¬</button>               
    
    <button class="align-btn red-btns hidden" style="background: #000; color: #e74c3c; font-weight: bold;" onclick="alignPlayers('red', true)">ì •ë ¬ â–¶</button>
  </div>

  <div class="center-box">
    <button id="toggleMenuBtn" onclick="toggleMenu()"class="menu-btn" style="font-size: 30px;">âš™ï¸</button>
  </div>

  <div class="side-box right" style="display: flex; gap: 5px;">
    <button class="align-btn blue-btns hidden" style="background: #000; color: #3498db; font-weight: bold;" onclick="alignPlayers('blue', true)">â—€ ì •ë ¬</button>
    
    <button id="blueAlignBtn" class="align-btn blue-btns hidden" style="background: #000; color: #3498db; font-weight: bold;" onclick="alignPlayers('blue', false)">ì •ë ¬ â–¶</button>
  </div>
</div>
  <div id="field-container">

      <div id="field-bg"></div>
    <div id="field">
      <div id="field-lines"><canvas id="drawingCanvas"></canvas></div>
      <div class="ball draggable" id="ball" style="left:50%; top:50%;"></div>
    </div>

    <div id="menuOverlay">
      <div id="bottomControls" class="collapsed">
        <div class="card">
<div class="card-header" style="display: flex; align-items: center; justify-content: space-between; padding: 2px 5px; min-height: 35px;">
    <div style="flex: 1;"></div>

    <h3 style="color:var(--red-color); margin:0; font-size:14px; text-align:center; flex: 1; white-space: nowrap;">RED</h3>

    <div style="flex: 1; display: flex; justify-content: flex-end;">
        <select class="formation-select" 
                onchange="applyFormation('red', this.value)"
style="padding: 2px 5px; border-radius: 12px; border: 1px solid #ddd; font-size: 11px; background: #f9f9f9; cursor: pointer; outline: none; 
                       width: 90px; 
                       min-width: 90px; 
                       text-align: center;">
            <option value="">í¬ë©”ì´ì…˜</option>
            <option value="4-4-2">4 - 4 - 2</option>
            <option value="4-3-3">4 - 3 - 3</option>
            <option value="3-5-2">3 - 5 - 2</option>
        </select>
    </div>
</div>

<div class="input-row">
  <input type="text" id="redInput" placeholder="ì„ ìˆ˜ëª…" onkeypress="if(event.key==='Enter')addPlayer('red')">
  <input type="color" id="redColorPicker" value="#ffffff" style="width:30px; height:30px; border:none; padding:0; background:none; cursor:pointer;" onchange="changeTeamNameColor('red', this.value)">
  <button class="btn-add" style="background:var(--red-color);" onclick="addPlayer('red')">ì¶”ê°€</button>
</div>

<div class="setting-grid" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
  <span style="font-size: 10px; width: 40px; flex-shrink: 0;">ìœ ë‹ˆí¼</span>

  <label style="flex: 1; min-width: 0; height: 20px; cursor: pointer; display: flex; align-items: center; background: #ececec; border: 1px solid #ccc; padding: 0 8px; border-radius: 10px; margin: 0;">
    <div id="redFileName" style="font-size: 9px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ì§€ì • ì•ˆë¨</div>
    <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event, 'red')">
  </label>

<div style="display: flex; gap: 4px; flex-shrink: 0;">
  <button type="button" class="shape-btn" onclick="changeShape('red', 'circle')" title="ì›í˜•">
    <svg viewBox="0 0 24 24" width="14" height="14"><circle cx="12" cy="12" r="10" fill="currentColor"/></svg>
  </button>
  <button type="button" class="shape-btn" onclick="changeShape('red', 'square')" title="ì‚¬ê°í˜•">
    <svg viewBox="0 0 24 24" width="14" height="14"><rect x="3" y="3" width="18" height="18" rx="2" fill="currentColor"/></svg>
  </button>
  <button type="button" class="shape-btn" onclick="changeShape('red', 'triangle')" title="ì‚¼ê°í˜•">
    <svg viewBox="0 0 24 24" width="14" height="14"><path d="M12 2L2 20h20L12 2z" fill="currentColor"/></svg>
  </button>
  <button type="button" class="shape-btn" onclick="changeShape('red', 'jersey')" title="ìœ ë‹ˆí¼">
    <svg viewBox="0 0 24 24" width="14" height="14"><path d="M7 2L2 5v4l3 1v12h14V10l3-1V5l-5-3-3 2-3-2z" fill="currentColor"/></svg>
  </button>
</div>
</div>

          <div class="setting-grid"><span>ì„ ìˆ˜í¬ê¸°</span><input type="range" id="redPlayerSize" min="30" max="100" value="55" oninput="updateTeamStyle('red')"></div>
          <div class="setting-grid"><span>ê¸€ìí¬ê¸°</span><input type="range" id="redFontSize" min="10" max="24" value="12" oninput="updateTeamStyle('red')"></div>
          <div id="redList" style="max-height:200px; overflow-y:auto; margin-top:5px;"></div>
        </div>

        <div class="card">
<div class="card-header" style="display: flex; align-items: center; justify-content: space-between; padding: 2px 5px; min-height: 35px;">
    <div style="flex: 1;"></div>

    <h3 style="color:var(--blue-color); margin:0; font-size:14px; text-align:center; flex: 1; white-space: nowrap;">BLUE</h3>

    <div style="flex: 1; display: flex; justify-content: flex-end;">
        <select class="formation-select" 
                onchange="applyFormation('blue', this.value)"
style="padding: 2px 5px; border-radius: 12px; border: 1px solid #ddd; font-size: 11px; background: #f9f9f9; cursor: pointer; outline: none; 
                       width: 90px; 
                       min-width: 90px; 
                       text-align: center;">
            <option value="">í¬ë©”ì´ì…˜</option>
            <option value="4-4-2">4 - 4 - 2</option>
            <option value="4-3-3">4 - 3 - 3</option>
            <option value="3-5-2">3 - 5 - 2</option>
        </select>
    </div>
</div>
<div class="input-row">
  <input type="text" id="blueInput" placeholder="ì„ ìˆ˜ëª…" onkeypress="if(event.key==='Enter')addPlayer('blue')">
  <input type="color" id="blueColorPicker" value="#ffffff" style="width:30px; height:30px; border:none; padding:0; background:none; cursor:pointer;" onchange="changeTeamNameColor('blue', this.value)">
  <button class="btn-add" style="background:var(--blue-color);" onclick="addPlayer('blue')">ì¶”ê°€</button>
</div>

<div class="setting-grid" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
  <span style="font-size: 10px; width: 40px; flex-shrink: 0;">ìœ ë‹ˆí¼</span>

  <label style="flex: 1; min-width: 0; height: 20px; cursor: pointer; display: flex; align-items: center; background: #ececec; border: 1px solid #ccc; padding: 0 8px; border-radius: 10px; margin: 0;">
    <div id="blueFileName" style="font-size: 9px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ì§€ì • ì•ˆë¨</div>
    <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event, 'blue')">
  </label>

<div style="display: flex; gap: 4px; flex-shrink: 0;">
  <button type="button" class="shape-btn" onclick="changeShape('blue', 'circle')" title="ì›í˜•">
    <svg viewBox="0 0 24 24" width="14" height="14"><circle cx="12" cy="12" r="10" fill="currentColor"/></svg>
  </button>
  <button type="button" class="shape-btn" onclick="changeShape('blue', 'square')" title="ì‚¬ê°í˜•">
    <svg viewBox="0 0 24 24" width="14" height="14"><rect x="3" y="3" width="18" height="18" rx="2" fill="currentColor"/></svg>
  </button>
  <button type="button" class="shape-btn" onclick="changeShape('blue', 'triangle')" title="ì‚¼ê°í˜•">
    <svg viewBox="0 0 24 24" width="14" height="14"><path d="M12 2L2 20h20L12 2z" fill="currentColor"/></svg>
  </button>
  <button type="button" class="shape-btn" onclick="changeShape('blue', 'jersey')" title="ìœ ë‹ˆí¼">
    <svg viewBox="0 0 24 24" width="14" height="14"><path d="M7 2L2 5v4l3 1v12h14V10l3-1V5l-5-3-3 2-3-2z" fill="currentColor"/></svg>
  </button>
</div>
</div>

          <div class="setting-grid"><span>ì„ ìˆ˜í¬ê¸°</span><input type="range" id="bluePlayerSize" min="30" max="100" value="55" oninput="updateTeamStyle('blue')"></div>
          <div class="setting-grid"><span>ê¸€ìí¬ê¸°</span><input type="range" id="blueFontSize" min="10" max="24" value="12" oninput="updateTeamStyle('blue')"></div>
          <div id="blueList" style="max-height:200px; overflow-y:auto; margin-top:5px;"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0; font-size:14px; text-align:center; color:#555;">SETTING</h3>
          <div class="setting-grid" style="margin-bottom:8px;">
     <span>íˆ¬ëª…ë„</span>
     <input type="range" min="10" max="100" value="98" oninput="updateMenuOpacity(this.value)"></div>
          <div class="setting-grid" style="margin-bottom:8px;">
    <span>ê³µí¬ê¸°</span>
    <input type="range" id="ballSize" min="20" max="100" value="45" oninput="updateBallSize(this.value)"></div>

<label class="file-btn-box">
    <div class="setting-grid">
        <span>ì¶•êµ¬ê³µ</span>
        <div style="font-size:9px; color:#999; overflow:hidden; white-space:nowrap;" id="ballFileName">ì§€ì • ì•ˆë¨</div>
    </div>
    <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event, 'ball')">
</label>

          <label class="file-btn-box">
            <div class="setting-grid"><span>ê²½ê¸°ì¥</span><div style="font-size:9px; color:#999; overflow:hidden; white-space:nowrap;" id="fieldNameDisplay">ì§€ì • ì•ˆë¨</div></div>
            <input type="file" id="fieldInput" style="display:none;" onchange="handleImageUpload(event, 'field')">
          </label>

<div class="setting-grid" style="margin-bottom:8px;">
  <span>íœ ë„êµ¬</span>
  <label class="switch">
    <input type="checkbox" id="penModeCheckbox" onchange="togglePenToolbar(this.checked)">
    <span class="slider"></span>
  </label>
</div>

<div class="setting-grid" style="margin-bottom:8px;">
  <span>ì •ë ¬ë²„íŠ¼</span>
<label class="switch">
    <input type="checkbox" id="alignCheckbox" onchange="toggleAlignButtons(this.checked)">
    <span class="slider"></span>
  </label>
</div>

<div class="setting-grid" style="margin-bottom:8px;">
  <span>ê²¹ì¹¨ë°©ì§€</span>
  <label class="switch">
    <input type="checkbox" id="overlapCheckbox" onchange="toggleOverlapPrevention(this.checked)">
    <span class="slider"></span>
  </label>
</div>

          <div class="data-btn-container" style="margin-top: 5px !important;">
            <button class="btn-full" style="background:#f39c12;" onclick="takeScreenshot()">ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·</button>
            <button class="btn-full" style="background:#2c3e50;" onclick="saveData()">ğŸ’¾ ì € ì¥</button>
            <button class="btn-full" style="background:#27ae60;" onclick="document.getElementById('fileLoader').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-full" style="background:#e74c3c;" onclick="resetAll()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
          </div>
          <input type="file" id="fileLoader" accept=".json" style="display:none;" onchange="loadData(event)">
        </div>
      </div>
    </div>
  </div>

  <script>
    const field = document.getElementById('field'), ball = document.getElementById('ball'), bottomControls = document.getElementById('bottomControls');
    let currentFileName = "soccerW_filed_data.json";
    const persistentImages = { red: null, blue: null, field: null, ball: null };
    const activeDrags = new Map();

    function makeDraggable(el) {
      const onStart = (e) => {
        if (e.target.closest('#bottomControls')) return;
        const touches = e.changedTouches || [e];
        for (const t of touches) {
          const id = t.identifier !== undefined ? t.identifier : 'mouse';
          const rect = el.getBoundingClientRect();
          activeDrags.set(id, { target: el, offsetX: t.clientX - (rect.left + rect.width / 2), offsetY: t.clientY - (rect.top + rect.height / 2) });
          el.style.transition = "none";
          el.style.zIndex = 1000;
        }
      };
const onMove = (e) => {
        const touches = e.changedTouches || [e];
        for (const t of touches) {
          const id = t.identifier !== undefined ? t.identifier : 'mouse';
          const d = activeDrags.get(id);
          if (d && d.target === el) {
            const fr = field.getBoundingClientRect();
            let x = ((t.clientX - fr.left - d.offsetX) / fr.width) * 100;
            let y = ((t.clientY - fr.top - d.offsetY) / fr.height) * 100;
            
            // 1. ì„ ìˆ˜ì˜ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            el.style.left = Math.max(0, Math.min(100, x)) + "%";
            el.style.top = Math.max(0, Math.min(100, y)) + "%";

            // 2. [ì—¬ê¸°ì— ì¶”ê°€!] ì„ ìˆ˜ê°€ ì›€ì§ì¼ ë•Œë§ˆë‹¤ ë‹¤ë¥¸ ì„ ìˆ˜ë¥¼ ë°€ì–´ë‚´ëŠ”ì§€ ì²´í¬í•©ë‹ˆë‹¤.
            preventOverlap(el); 
          }
        }
        if (activeDrags.size > 0 && e.cancelable) e.preventDefault();
      };
      const onEnd = (e) => {
        const touches = e.changedTouches || [e];
        for (const t of touches) { activeDrags.delete(t.identifier !== undefined ? t.identifier : 'mouse'); }
el.style.zIndex = el.classList.contains('ball') ? 2000 : 5;

        setTimeout(() => { el.style.transition = "left 0.4s ease-out, top 0.4s ease-out"; }, 10);
      };
      el.addEventListener('mousedown', onStart);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onEnd);
      el.addEventListener('touchstart', onStart, { passive: false });
      window.addEventListener('touchmove', onMove, { passive: false });
      window.addEventListener('touchend', onEnd);
    }

    // ì‹¤ì‹œê°„ íŒ€ ì´ë¦„ ìƒ‰ìƒ ë³€ê²½
    function changeTeamNameColor(team, color) {
      document.querySelectorAll(`.player[data-team="${team}"]`).forEach(p => p.style.color = color);
    }

  function addPlayer(t, n=null, x="50%", y="50%", c=null) {
  const input = document.getElementById(t+'Input'), name = n || input.value.trim();
  if(!name) return;
const chosenColor = c || document.getElementById(t+'ColorPicker').value;
  const p = document.createElement('div');
  
  const currentShape = (typeof teamShapes !== 'undefined') ? teamShapes[t] : 'circle';
  const currentSize = document.getElementById(t + 'PlayerSize').value;
  const currentFontSize = document.getElementById(t + 'FontSize').value;

  p.className = `player draggable shape-${currentShape}`; 
  p.innerText = name; 
  p.style.left = x; 
  p.style.top = y; 
  p.dataset.team = t;
  p.style.color = chosenColor;
  p.style.zIndex = 10;

  p.style.width = currentSize + 'px';
  p.style.height = currentSize + 'px';
  p.style.fontSize = currentFontSize + 'px';
  
  if(persistentImages[t]) { 
    p.style.backgroundImage = `url(${persistentImages[t]})`; 
    p.style.backgroundColor = 'transparent'; 
  } else { 
    p.style.backgroundColor = 'rgba(0,0,0,0.3)'; 
  }
  
updateAlignButtons();
  makeDraggable(p); 
  field.appendChild(p);

  // 3. ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìƒì„± ë° ì—°ê²°
  const list = document.getElementById(t+'List'), item = document.createElement('div');
  item.className = 'list-item'; 
  item.playerEl = p; // ì´ ì¤„ì´ ìˆì–´ì•¼ ë¦¬ìŠ¤íŠ¸ ë“œë˜ê·¸ ì‹œ ì„ ìˆ˜ê°€ ì›€ì§ì„
  
  item.setAttribute('draggable', 'true');
  item.dataset.team = t;
  item.ondragstart = handleDragStart;
  item.ondragover = handleDragOver;
  item.ondrop = handleDrop;
  item.ondragend = handleDragEnd;

  item.innerHTML = `
    <div class="drag-handle" style="cursor: grab; padding: 1px 10px; margin-left: -8px; color: #888; font-size: 15px; display: flex; align-items: center; justify-content: center;">â˜°</div>
    <span style="flex:1; font-weight:bold; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; pointer-events: none;">${name}</span>
    <div style="display:flex; gap:3px; padding-right: 5px;">
      <button class="btn-small" onclick="editPlayer(this)">ìˆ˜ì •</button>
      <button class="btn-small" style="color:red;" onclick="removePlayer(this)">ì‚­ì œ</button>
    </div>`;
    
  list.appendChild(item); 
  if(!n) input.value = "";
  updateAlignButtons();
} 


    function saveData() {
      const fn = prompt("íŒŒì¼ëª… ì…ë ¥:", currentFileName.replace(".json", ""));
      if (!fn) return;
      currentFileName = fn + ".json";
      const players = Array.from(document.querySelectorAll('.player')).map(p => ({
        name: p.innerText, team: p.dataset.team, x: p.style.left, y: p.style.top, color: p.style.color
      }));
      const config = { players, ball: { x: ball.style.left, y: ball.style.top, size: ball.style.width || "45px" }, images: persistentImages };
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([JSON.stringify(config)], {type: "application/json"}));
      a.download = currentFileName; a.click();
    }

function createPlayerItem(player) {
        return `
        <div class="player-list-item" draggable="true" data-id="${player.id}" 
             ondragstart="handleDragStart(event)" 
             ondragover="handleDragOver(event)" 
             ondrop="handleDrop(event)" 
             ondragend="handleDragEnd(event)">
            <div class="drag-handle" style="cursor: grab; padding: 0 5px; color: #ccc;">â˜°</div>
            <span class="player-name-display">${player.name}</span>
            <button onclick="removePlayer('${player.team}', '${player.id}')">Ã—</button>
        </div>
        `;
    }
let dragSrcEl = null; // ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œë¥¼ ì €ì¥í•  ë³€ìˆ˜

// 1. ë“œë˜ê·¸ ì‹œì‘: íˆ¬ëª…ë„ ì¡°ì ˆ
function handleDragStart(e) {
  dragSrcEl = this; 
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

// 2. ë“œë˜ê·¸ ì˜¤ë²„: ë“œë¡­ í—ˆìš©
function handleDragOver(e) {
  if (e.preventDefault) e.preventDefault();
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) e.stopPropagation();
  
  if (dragSrcEl !== this) {
    if (dragSrcEl.parentNode === this.parentNode) {
      const list = this.parentNode;
      
      // --- ì¶”ê°€ëœ ë¡œì§: ê²½ê¸°ì¥ ìœ„ ì‹¤ì œ ì¢Œí‘œ ë§ë°”ê¾¸ê¸° ---
      const p1 = dragSrcEl.playerEl; // ë“œë˜ê·¸í•œ ì„ ìˆ˜ ëª¨í˜•
      const p2 = this.playerEl;      // ë†“ì€ ìœ„ì¹˜ì— ìˆë˜ ì„ ìˆ˜ ëª¨í˜•

      if (p1 && p2) {
        // ì„œë¡œì˜ ì¢Œí‘œ(left, top)ë¥¼ ë°±ì—… í›„ êµì²´
        const tempLeft = p1.style.left;
        const tempTop = p1.style.top;

        p1.style.left = p2.style.left;
        p1.style.top = p2.style.top;

        p2.style.left = tempLeft;
        p2.style.top = tempTop;
      }


      const allItemsArray = [...list.querySelectorAll('.list-item')];
      if (allItemsArray.indexOf(dragSrcEl) < allItemsArray.indexOf(this)) {
        list.insertBefore(dragSrcEl, this.nextSibling);
      } else {
        list.insertBefore(dragSrcEl, this);
      }
      
      // 2. ê²¹ì¹¨ ìˆœì„œ(zIndex) ìµœì‹ í™”
      list.querySelectorAll('.list-item').forEach((item, index) => {
        if (item.playerEl) item.playerEl.style.zIndex = 10 + index;
      });

      // 3. ìë™ ì €ì¥
      if (typeof autoSaveToLocal === 'function') autoSaveToLocal();
    }
  }
  return false;
}

// 4. ë“œë˜ê·¸ ì¢…ë£Œ: íˆ¬ëª…ë„ ë³µêµ¬
function handleDragEnd(e) {
  this.style.opacity = '1';
  // renderPlayerList(); // <- ì´ ì¤„ì€ ì‚­ì œí•˜ì„¸ìš”! í˜¸ì¶œí•˜ë©´ ìˆœì„œê°€ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
}
// 5. ì•Œë¦¼ì°½ ì—†ëŠ” ìë™ ì €ì¥ í•¨ìˆ˜
function autoSaveToLocal() {
  const players = Array.from(document.querySelectorAll('.player')).map(p => ({
    name: p.innerText, team: p.dataset.team, x: p.style.left, y: p.style.top, color: p.style.color
  }));
  const config = { players, ball: { x: ball.style.left, y: ball.style.top, size: ball.style.width || "45px" }, images: persistentImages };
  localStorage.setItem('soccerAutoSave', JSON.stringify(config));
}

    /* --- ê·¸ë¦¬ê³  ì•„ë˜ì˜ renderPlayerList í•¨ìˆ˜ë¥¼ ì°¾ì•„ ë‚´ìš©ì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤ --- */
    function renderPlayerList() {
        const redList = document.getElementById('redPlayerList');
        const blueList = document.getElementById('bluePlayerList');
        
        redList.innerHTML = '';
        redPlayers.forEach(player => {
            // ì´ ë¶€ë¶„ì´ ì¤‘ìš”! ìœ„ì—ì„œ ë§Œë“  í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì±„ì›ë‹ˆë‹¤.
            redList.innerHTML += createPlayerItem(player);
        });

        blueList.innerHTML = '';
        bluePlayers.forEach(player => {
            blueList.innerHTML += createPlayerItem(player);
        });
    }

// ì™¸ë¶€ ì£¼ì†Œ ì´ë¯¸ì§€ë¥¼ ë³´ì•ˆ í—ˆìš©í•˜ë©° ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ (ì„¤ëª…ì„œ)
function setExternalImage(target, url) {
  if (!url) return;
  const img = new Image();
  img.crossOrigin = "Anonymous"; // ë³´ì•ˆ í—ˆìš© ìš”ì²­ì˜ í•µì‹¬!
  img.src = url;
  img.onload = function() {
    if(target === 'field') {
      field.style.backgroundImage = `url('${url}')`;
    } else {
      document.querySelectorAll(`.player[data-team="${target}"]`).forEach(p => {
        p.style.backgroundImage = `url('${url}')`;
        p.style.backgroundColor = 'transparent';
      });
    }
  };
}

    function loadData(event) {
      const file = event.target.files[0]; if (!file || !confirm("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const d = JSON.parse(e.target.result);

        document.querySelectorAll('.player, .list-item').forEach(el => el.remove());
// 2. [ì¶”ê°€] í•„ë“œ ë°°ê²½ ì´ˆê¸°í™” (íŒŒì¼ì— ë°°ê²½ì´ ì—†ë”ë¼ë„ ê¸°ë³¸ìœ¼ë¡œ ë˜ëŒë¦¼)
    const defaultField = 'https://postfiles.pstatic.net/MjAyNjAxMjlfMjI1/MDAxNzY5NjM1Mjc0NjQ5.502_CqNalGrTYu6ZLubeKv3k_Yi01fCGmv4_tRIq_a4g.BvhqNdBmteUb3ZSa07vyILSugnFty_RPVM18IN9cxYAg.PNG/field.png?type=w580';
    field.style.backgroundImage = `url('${defaultField}')`;
    document.getElementById('fieldNameDisplay').innerText = "ì§€ì • ì•ˆë¨";
    persistentImages.field = null; // ë©”ëª¨ë¦¬ìƒì˜ ë°°ê²½ ë°ì´í„°ë„ ì´ˆê¸°í™”

        if (d.images) { 
          Object.assign(persistentImages, d.images); 

// loadData í•¨ìˆ˜ ë‚´ë¶€ì˜ d.images.field ì²˜ë¦¬ ë¶€ë¶„
if (d.images.field) {
  persistentImages.field = d.images.field; // ë©”ëª¨ë¦¬ì— ì €ì¥
  const bgLayer = document.getElementById('field-bg');
  if(bgLayer) {
    bgLayer.style.backgroundImage = `url(${d.images.field})`;
  }
  document.getElementById('fieldNameDisplay').innerText = "ë¶ˆëŸ¬ì˜¨ ë°°ê²½";
}

      if (d.images.red) setExternalImage('red', d.images.red);
      if (d.images.blue) setExternalImage('blue', d.images.blue);
 
if (d.images.ball) {
        ball.style.backgroundImage = `url('${d.images.ball}')`;
        ball.style.backgroundColor = 'transparent';
        ball.style.backgroundSize = 'cover';
        if(document.getElementById('ballFileName')) {
            document.getElementById('ballFileName').innerText = "ì €ì¥ëœ ê³µ";
        }
      }
    }  

        if(d.players) d.players.forEach(p => addPlayer(p.team, p.name, p.x, p.y, p.color));
        if (d.ball) { ball.style.left = d.ball.x; ball.style.top = d.ball.y; if(d.ball.size) {
    ball.style.width = d.ball.size;
    ball.style.height = d.ball.size;
const ballSlider = document.getElementById('ballSize');
    if (ballSlider) {
ballSlider.value = parseInt(d.ball.size); // d.ball.sizeì—ì„œ ìˆ«ìë¥¼ ì§ì ‘ ì¶”ì¶œ
    }
  }
}
      };
      reader.readAsText(file);
      event.target.value = '';
    }

 function takeScreenshot() {
  const wasCollapsed = bottomControls.classList.contains('collapsed');
  if (!wasCollapsed) toggleMenu(); // ë©”ë‰´ ìˆ¨ê¸°ê¸°

  // 0.5ì´ˆ ëŒ€ê¸° (ë©”ë‰´ê°€ ì™„ì „íˆ ì‚¬ë¼ì§„ í›„ ìº¡ì²˜)
  setTimeout(() => {
    const target = document.querySelector("#field");
    
    html2canvas(target, {
      useCORS: true,           // ì™¸ë¶€ ì´ë¯¸ì§€ í—ˆìš©
      allowTaint: true,       // ë³´ì•ˆ ì •ì±… ì¤€ìˆ˜
      scale: 2,                // ê³ í™”ì§ˆ (2ë°°)
      backgroundColor: "#27ae60", // ë°°ê²½ì´ ë¹„ì–´ìˆì„ ë•Œ ê¸°ë³¸ ì´ˆë¡ìƒ‰ ì ìš©
      logging: true,
      width: target.offsetWidth,
      height: target.offsetHeight
    }).then(canvas => {
      try {
        const link = document.createElement('a');
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "");
        const timeStr = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
        
        // íŒŒì¼ í˜•ì‹ì„ pngë¡œ ë³€ê²½ (ë¼ì¸ íˆ¬ëª…ë„ ìœ ì§€ì— ìœ ë¦¬)
        link.download = `${dateStr}_${timeStr}_soccerW.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (e) {
        console.error("ìº¡ì²˜ ì—ëŸ¬:", e);
        alert("ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì •ìœ¼ë¡œ ì¸í•´ ìŠ¤í¬ë¦°ìƒ·ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì—…ë¡œë“œí•œ ìƒíƒœì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
      
      if (!wasCollapsed) toggleMenu(); // ë‹¤ì‹œ ë©”ë‰´ í‘œì‹œ
    });
  }, 500);
}


 async function handleImageUpload(e, t) {
  const f = e.target.files[0]; if(!f) return;
  const b = await new Promise(r=>{
    const rd=new FileReader(); 
    rd.readAsDataURL(f); 
    rd.onload=()=>r(rd.result);
  });
  
  persistentImages[t] = b;
  
// handleImageUpload í•¨ìˆ˜ ë‚´ë¶€ ìˆ˜ì •
if(t === 'field') { 
    document.getElementById('field-bg').style.backgroundImage = `url(${b})`; 
    document.getElementById('fieldNameDisplay').innerText = "ë°°ê²½:" + f.name; 
}
else if(t==='ball') {
    ball.style.backgroundImage = `url(${b})`;
    ball.style.backgroundColor = 'transparent'; // ê¸°ë³¸ íšŒìƒ‰ ì œê±°
    ball.style.backgroundSize = 'cover';
    ball.style.backgroundPosition = 'center';
    document.getElementById('ballFileName').innerText = "ê³µ:" + f.name;
  }
else { 
    document.querySelectorAll(`.player[data-team="${t}"]`).forEach(p=>{ 
      p.style.backgroundImage=`url(${b})`; 
      p.style.backgroundColor = 'transparent'; 
      // ì•„ë˜ ë‘ ì¤„ì„ ì¶”ê°€í•˜ë©´ ìŠ¤í¬ë¦°ìƒ· ì„±ê³µ í™•ë¥ ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.
      p.style.backgroundSize = 'cover';
      p.style.backgroundPosition = 'center';
    }); 
    document.getElementById(t+'FileName').innerText = f.name; 
  }
}
    function updateTeamStyle(t){
      const s=document.getElementById(t+'PlayerSize').value, f=document.getElementById(t+'FontSize').value;
      document.querySelectorAll(`.player[data-team="${t}"]`).forEach(p=>{p.style.width=s+'px';p.style.height=s+'px';p.style.fontSize=f+'px';});
    }
function updateBallSize(v) {
  const ball = document.getElementById('ball');
  ball.style.width = v + 'px';
  ball.style.height = v + 'px';
}
    function applyFormation(t, f) {
      const ps = Array.from(document.getElementById(t+'List').children).map(it => it.playerEl), forms = {'4-4-2':[[10,50],[20,20],[20,40],[20,60],[20,80],[32,20],[32,40],[32,60],[32,80],[44,35],[44,65]],'4-3-3':[[10,50],[20,20],[20,40],[20,60],[20,80],[32,30],[32,50],[32,70],[44,20],[44,50],[44,80]],'3-5-2':[[10,50],[20,25],[20,50],[20,75],[32,15],[32,32],[32,50],[32,68],[32,85],[44,35],[44,65]]};
      const pos = forms[f]; if(!pos) return;
      ps.forEach((p, i)=>{ if(pos[i]){ let x=t==='blue'?100-pos[i][0]:pos[i][0]; p.style.left=x+"%"; p.style.top=pos[i][1]+"%"; }});
    }
    function toggleMenu() { const col = bottomControls.classList.toggle('collapsed'); document.getElementById('toggleMenuBtn').innerText = col ?  "âš™ï¸" : "âš™ï¸"; }
    function updateMenuOpacity(v) { bottomControls.style.opacity = v / 100; }
    function resetAll() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload(); }
    function moveOrder(btn, dir) {
      const it = btn.closest('.list-item'), target = dir === 'up' ? it.previousElementSibling : it.nextElementSibling;
      if(!target) return;
      const p1 = it.playerEl, p2 = target.playerEl;
      const tx = p1.style.left, ty = p1.style.top;
      p1.style.left = p2.style.left; p1.style.top = p2.style.top;
      p2.style.left = tx; p2.style.top = ty;
      if(dir==='up') it.parentNode.insertBefore(it, target); else it.parentNode.insertBefore(target, it);
    }
function removePlayer(btn) { 
  const it = btn.closest('.list-item'); 
  if (it.playerEl) it.playerEl.remove(); // í•„ë“œ ìœ„ ì„ ìˆ˜ ì œê±°
  it.remove(); // ë¦¬ìŠ¤íŠ¸ ëª©ë¡ ì œê±°

  updateAlignButtons();
}
    function editPlayer(btn) {
      const it = btn.closest('.list-item'), span = it.querySelector('span'), newName = prompt("ìˆ˜ì •:", span.innerText);
      if(newName) { span.innerText = newName; it.playerEl.innerText = newName; }
    }

// í•„ë“œ í¬ê¸°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°ì ˆí•˜ëŠ” í•¨ìˆ˜
    function adjustZoom(val) {
      const container = document.getElementById('field-container');
      const zoomText = document.getElementById('zoomVal');
      
      // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ë¥¼ ìŠ¬ë¼ì´ë” ê°’ì— ë”°ë¼ ë³€ê²½ (ìµœì†Œ 200pxê¹Œì§€ ì‘ì•„ì§)
      container.style.width = val + 'px';
      
      // í˜„ì¬ í¬ê¸°ë¥¼ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
      if(zoomText) zoomText.innerText = val + 'px';
    }

    makeDraggable(ball);

// ë‘ ì†ê°€ë½ í™•ëŒ€(Pinch Zoom) ë°©ì§€
document.addEventListener('touchstart', function (e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

// ë”ë¸” íƒ­ í™•ëŒ€ ë°©ì§€
let lastTouchEnd = 0;
document.addEventListener('touchend', function (e) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);

function updateAlignButtons() {
    const redCount = document.querySelectorAll('#redList .list-item').length;
    const blueCount = document.querySelectorAll('#blueList .list-item').length;

    const isVisible = (typeof isAlignVisible !== 'undefined') ? isAlignVisible : false;

    // RED ë²„íŠ¼ ê·¸ë£¹ ì œì–´ (ì´ì œ ì¸ì›ìˆ˜ì™€ ìƒê´€ì—†ì´ ìŠ¤ìœ„ì¹˜ë§Œ ì¼œì§€ë©´ ë³´ì…ë‹ˆë‹¤)
    document.querySelectorAll('.red-btns').forEach(btn => {
        btn.style.display = isVisible ? "inline-block" : "none";
        btn.classList.toggle('hidden', !isVisible);
    });

    // BLUE ë²„íŠ¼ ê·¸ë£¹ ì œì–´
    document.querySelectorAll('.blue-btns').forEach(btn => {
        btn.style.display = isVisible ? "inline-block" : "none";
        btn.classList.toggle('hidden', !isVisible);
    });
}
let isAlignVisible = false; 

function toggleAlignButtons(show) {
isAlignVisible = show; 
    updateAlignButtons();
}


function alignPlayers(team, isReverse = false) {
  const listItems = document.querySelectorAll(`#${team}List .list-item`);
  const players = Array.from(listItems).map(item => item.playerEl).filter(p => p);

  if (players.length === 0) return;

  const startY = 15; // ì‹œì‘ ë†’ì´ (%)
  const endY = 85;   // ë ë†’ì´ (%)
  const playersPerCol = 10; // í•œ ì—´ì— ë°°ì¹˜í•  ìµœëŒ€ ì¸ì›ìˆ˜

  players.forEach((p, i) => {
    // ì—´ ë²ˆí˜¸ ê³„ì‚° (0ë¶€í„° ì‹œì‘)
    const colIndex = Math.floor(i / playersPerCol);
    // ì—´ ë‚´ì—ì„œì˜ ìˆœì„œ (0~5)
    const rowIndex = i % playersPerCol;
    
    // í•´ë‹¹ ì—´ì— ëª‡ ëª…ì´ ìˆëŠ”ì§€ ê³„ì‚° (ê°„ê²© ì¡°ì ˆìš©)
    const countInThisCol = (colIndex === Math.floor((players.length - 1) / playersPerCol)) 
                           ? (players.length % playersPerCol || playersPerCol) 
                           : playersPerCol;

    // ê°„ê²© ê³„ì‚°
    const gap = countInThisCol > 1 ? (endY - startY) / (countInThisCol - 1) : 0;

    // Xì¶• ìœ„ì¹˜ ê²°ì • (ì—´ì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ì•ˆìª½ìœ¼ë¡œ 7%ì”© ë“¤ì–´ì˜´)
    let targetX;
    if (team === 'red') {
      const baseRedX = isReverse ? 90 : 10;
      const offset = colIndex * 8; // 2ì—´ì€ 8% ë” ì•ˆìª½ìœ¼ë¡œ
      targetX = isReverse ? baseRedX - offset : baseRedX + offset;
    } else {
      const baseBlueX = isReverse ? 10 : 90;
      const offset = colIndex * 8;
      targetX = isReverse ? baseBlueX + offset : baseBlueX - offset;
    }

    p.style.left = `${targetX}%`;
    p.style.top = countInThisCol > 1 ? `${startY + (gap * rowIndex)}%` : "50%";
  });

  if (typeof autoSaveToLocal === 'function') autoSaveToLocal();
}

function toggleOverlapPrevention(show) {
  isOverlapPreventionActive = show;
}

function preventOverlap(activeEl) {
  if (!isOverlapPreventionActive) return;

const targets = document.querySelectorAll('.player, .ball'); 
  const activeRect = activeEl.getBoundingClientRect();
  const radius = activeRect.width / 4;

  targets.forEach(target => {
    if (target === activeEl) return;

    const targetRect = target.getBoundingClientRect();
    const dx = (activeRect.left + radius) - (targetRect.left + radius);
    const dy = (activeRect.top + radius) - (targetRect.top + radius);
    const distance = Math.sqrt(dx * dx + dy * dy);

    // ì„ ìˆ˜ ì§€ë¦„ì˜ 90% ì •ë„ ê±°ë¦¬ ì•ˆì— ë“¤ì–´ì˜¤ë©´ ë°€ì–´ëƒ„
    const minDistance = activeRect.width * 0.9; 
    
    if (distance < minDistance && distance > 0) {
      const angle = Math.atan2(dy, dx);
      const push = (minDistance - distance);
      const pushX = Math.cos(angle) * push;
      const pushY = Math.sin(angle) * push;

      const fr = field.getBoundingClientRect();
      // ë°€ë ¤ë‚˜ëŠ” ì„ ìˆ˜ì˜ ìƒˆë¡œìš´ ì¢Œí‘œ (%) ê³„ì‚°
      let newX = ((targetRect.left - pushX - fr.left + (targetRect.width/2)) / fr.width) * 100;
      let newY = ((targetRect.top - pushY - fr.top + (targetRect.height/2)) / fr.height) * 100;

      target.style.left = Math.max(0, Math.min(100, newX)) + "%";
      target.style.top = Math.max(0, Math.min(100, newY)) + "%";
    }
  });
}

// íŒ€ë³„ í˜„ì¬ ëª¨ì–‘ ìƒíƒœ ì €ì¥ (ê¸°ë³¸ê°’ circle)
let teamShapes = { red: 'circle', blue: 'circle' };

function changeShape(team, shape) {
    // 1. ìƒíƒœ ì—…ë°ì´íŠ¸
    teamShapes[team] = shape;

    // 2. ë²„íŠ¼ í™œì„±í™” í‘œì‹œ (ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°)
    const btnGroup = event.currentTarget.parentElement;
    btnGroup.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');

    // 3. í•„ë“œ ìœ„ ì„ ìˆ˜ë“¤ ëª¨ì–‘ ì¦‰ì‹œ ë³€ê²½
    updateTeamStyle(team);
}

function updateTeamStyle(team) {
  // 1. í˜„ì¬ ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
  const size = document.getElementById(team + 'PlayerSize').value;
  const fontSize = document.getElementById(team + 'FontSize').value;
  const shape = teamShapes[team] || 'circle';

  // 2. í•´ë‹¹ íŒ€ì˜ ëª¨ë“  ì„ ìˆ˜(ëª¨í˜•) ì—…ë°ì´íŠ¸
  const players = document.querySelectorAll(`.player[data-team="${team}"]`);
  players.forEach(p => {
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.fontSize = fontSize + 'px';
    
    // ëª¨ì–‘ í´ë˜ìŠ¤ ì¼ê´„ ì ìš©
    p.classList.remove('shape-circle', 'shape-square', 'shape-triangle', 'shape-jersey');
    p.classList.add('shape-' + shape);
  });
  
  // 3. ì €ì¥
  autoSaveToLocal();
}

function togglePenToolbar(isVisible) {
    const penToolbar = document.getElementById('penToolbar');
    if (!penToolbar) return;
    penToolbar.style.display = isVisible ? 'flex' : 'none';
    if (!isVisible && penActive) togglePenMode();
}


let penActive = false;
const canvas = document.getElementById('drawingCanvas');
const ctx = canvas.getContext('2d');

function togglePenMode() {
    const btn = document.getElementById('penToggleBtn');
    const container = document.getElementById('field-container');
    
    penActive = !penActive;

    if (penActive) {
        btn.innerHTML = "ğŸ–ï¸";
btn.style.fontSize = "15px";
        btn.style.background = "#e74c3c";
        
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
    } else {
        btn.innerHTML = "ğŸ–ï¸";
btn.style.fontSize = "15px";
        btn.style.background = "#ffffff";
    }
}

function saveState() {
    undoStack.push(canvas.toDataURL());
    if (undoStack.length > 20) undoStack.shift(); // ìµœëŒ€ 20ê°œê¹Œì§€ ì €ì¥
    redoStack = []; // ìƒˆ ê·¸ë¦¼ì„ ê·¸ë¦¬ë©´ ì•ìœ¼ë¡œê°€ê¸° ê¸°ë¡ ì‚­ì œ
}

// ë’¤ë¡œê°€ê¸°
function undo() {
    if (undoStack.length === 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    redoStack.push(canvas.toDataURL());
    let previous = undoStack.pop();
    renderImage(previous);
}

// ì•ìœ¼ë¡œê°€ê¸°
function redo() {
    if (redoStack.length === 0) return;
    undoStack.push(canvas.toDataURL());
    let next = redoStack.pop();
    renderImage(next);
}

function renderImage(src) {
    let img = new Image();
    img.src = src;
    img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
    };
}

// ê¸°ì¡´ stopDrawing í•¨ìˆ˜ë¥¼ ì•„ë˜ì²˜ëŸ¼ ìˆ˜ì • (ì €ì¥ ë¡œì§ ì¶”ê°€)
function stopDrawing() { 
    if(isDrawing) saveState(); 
    isDrawing = false; 
}

// --- íœ ê¸°ëŠ¥ í•µì‹¬ ë¡œì§ ---

let isDrawing = false;

function updateLineWidth(v) { if(ctx) {
        ctx.lineWidth = v;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    } }


function changePenColor(v) { if(ctx) ctx.strokeStyle = v; }

function clearCanvas()  {
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
}

function getCanvasPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
}

window.addEventListener('mousedown', (e) => {
    if (!penActive) return;
    // ë²„íŠ¼ì´ë‚˜ ì…ë ¥ì°½ì„ ëˆ„ë¥¼ ë•ŒëŠ” ê·¸ë¦¬ê¸° ë°©ì§€
    if (e.target.closest('#penToolbar') || e.target.closest('#bottomControls')) return;

    isDrawing = true;
    const {x, y} = getCanvasPos(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
    
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = document.getElementById('penWidth').value;
    ctx.strokeStyle = document.getElementById('penColorPicker').value;
});

window.addEventListener('mousemove', (e) => {
    if (!isDrawing || !penActive) return; // í´ë¦­ ìƒíƒœ(isDrawing)ê°€ trueì¼ ë•Œë§Œ ì‹¤í–‰
    const {x, y} = getCanvasPos(e);
    ctx.lineTo(x, y);
    ctx.stroke();
});

window.addEventListener('mouseup', () => {
    isDrawing = false; // ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ë” ì´ìƒ ê·¸ë ¤ì§€ì§€ ì•ŠìŒ
});

// í„°ì¹˜ ëª¨ë°”ì¼ ì§€ì›
window.addEventListener('touchstart', (e) => {
    if (!penActive || e.target.closest('#penToolbar')) return;
    isDrawing = true;
    const {x, y} = getCanvasPos(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
}, {passive: false});

window.addEventListener('touchmove', (e) => {
    if (!isDrawing || !penActive) return;
    const {x, y} = getCanvasPos(e);
    ctx.lineTo(x, y);
    ctx.stroke();
    if(e.cancelable) e.preventDefault();
}, {passive: false});

window.addEventListener('touchend', () => { isDrawing = false; });


let points = [];

function startDrawing(e) {
    if (!penActive) return;
    if (e.target.closest('#penToolbar') || e.target.closest('#bottomControls')) return;

    isDrawing = true;
    const pos = getCanvasPos(e);
    points = [pos]; // ì‹œì‘ì  ì €ì¥
    
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    
    // íœ ìŠ¤íƒ€ì¼ ì„¤ì •
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = document.getElementById('penWidth').value;
    ctx.strokeStyle = document.getElementById('penColorPicker').value;
}

function draw(e) {
    if (!isDrawing || !penActive) return;
    
    const pos = getCanvasPos(e);
    points.push(pos);

    if (points.length > 2) {
        // ë§ˆì§€ë§‰ ì„¸ ì ì„ ì´ìš©í•´ ë¶€ë“œëŸ¬ìš´ ê³¡ì„ (ë² ì§€ì–´ ê³¡ì„ ) ê³„ì‚°
        const lastTwoPoints = points.slice(-2);
        const controlPoint = lastTwoPoints[0];
        const endPoint = {
            x: (lastTwoPoints[0].x + lastTwoPoints[1].x) / 2,
            y: (lastTwoPoints[0].y + lastTwoPoints[1].y) / 2
        };

        ctx.quadraticCurveTo(controlPoint.x, controlPoint.y, endPoint.x, endPoint.y);
        ctx.stroke();
    }
}
function stopDrawing() { 
    if(isDrawing && typeof saveState === 'function') saveState(); 
    isDrawing = false; 
}

  </script>
</body>
</html>

